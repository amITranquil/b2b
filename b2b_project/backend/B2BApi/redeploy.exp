#!/usr/bin/expect -f

set timeout -1
set password "TRansit2022,."
set host "root@192.168.1.8"

# 1. API dosyalarÄ±nÄ± kopyala (linux-arm64 build)
puts "ğŸ“¤ API dosyalarÄ± kopyalanÄ±yor (linux-arm64)...\n"
spawn rsync -avz --progress --exclude=*.db --exclude=*.db-shm --exclude=*.db-wal --exclude=wwwroot/*.html --exclude=wwwroot/*.js --exclude=wwwroot/*.css --exclude=wwwroot/*.md ./bin/Release/publish/ $host:/home/dietpi/b2bapi/publish/
expect {
    "password:" { send "$password\r"; exp_continue }
    eof
}

puts "\nâœ… API dosyalarÄ± kopyalandÄ±\n"

# 2. Ä°zinleri dÃ¼zenle
puts "ğŸ” Ä°zinler dÃ¼zenleniyor...\n"
spawn ssh $host "chown -R dietpi:dietpi /home/dietpi/b2bapi/publish && chmod +x /home/dietpi/b2bapi/publish/B2BApi"
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "\nâœ… Ä°zinler dÃ¼zenlendi\n"

# 3. Service'i yeniden baÅŸlat
puts "ğŸ”„ Service yeniden baÅŸlatÄ±lÄ±yor...\n"
spawn ssh $host "systemctl restart b2b-api.service && sleep 3 && systemctl status b2b-api.service --no-pager -l"
expect {
    "password:" { send "$password\r" }
}
expect eof

puts "\nâœ… Deployment tamamlandÄ±!\n"
